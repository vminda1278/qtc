# "service" is the name of this project. This will also be added to your AWS resource names.
service: qwiktax

package:
  patterns:
    - '!.env'
    - '!.env.*'
    - '!.env.example'
    - '!.env.local'
    - '!.env.backup'
    - '!node_modules/.cache/**'
    - '!node_modules/aws-sdk/**'
    - '!node_modules/@aws-sdk/**'
    - '!node_modules/@smithy/**'
    - '!node_modules/nodemon/**'
    - '!node_modules/serverless/**'
    - '!node_modules/serverless-*/**'
    - '!node_modules/**/test/**'
    - '!node_modules/**/tests/**'
    - '!node_modules/**/benchmark/**'
    - '!node_modules/**/benchmarks/**'
    - '!node_modules/**/*.md'
    - '!node_modules/**/*.markdown'
    - '!node_modules/**/*.txt'
    - '!node_modules/**/*.map'
    - '!node_modules/**/*.ts'
    - '!node_modules/**/*.d.ts'
    - '!node_modules/**/README*'
    - '!node_modules/**/CHANGELOG*'
    - '!node_modules/**/LICENSE*'
    - '!node_modules/**/HISTORY*'
    - '!node_modules/**/.npmignore'
    - '!node_modules/**/.gitignore'
    - '!node_modules/**/.travis.yml'
    - '!node_modules/**/.editorconfig'
    - '!node_modules/**/.eslintrc*'
    - '!node_modules/**/example/**'
    - '!node_modules/**/examples/**'
    - '!node_modules/**/docs/**'
    - '!node_modules/**/documentation/**'
    - '!node_modules/**/Makefile'
    - '!node_modules/**/*.spec.js'
    - '!node_modules/**/*.test.js'
    - '!test/**'
    - '!docs/**'
    - '!scripts/**'
    - '!*.md'
    - '!.git/**'
    - '!.gitignore'
    - '!.DS_Store'
    - '!.serverless/**'
  individually: false
  excludeDevDependencies: true

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'vikas'}
  profile: beejcap-aws
  region: us-east-1
  environment:
    # DynamoDB Table
    DYNAMODB_TABLE: qwiktax_${self:provider.stage}
    # Stage and Region
    STAGE: ${self:provider.stage}
    # JWT Secret for OTP-based authentication
    JWT_SECRET: ${env:JWT_SECRET}
    # Google OAuth Configuration
    GOOGLE_CLIENT_ID: ${self:custom.googleClientId.${self:provider.stage}}
    GOOGLE_CLIENT_SECRET: ${self:custom.googleClientSecret.${self:provider.stage}}
    GOOGLE_REDIRECT_URI: ${self:custom.googleRedirectUri.${self:provider.stage}}
    # S3 Bucket for assets
    S3_ASSETS_BUCKET:
      Ref: S3AssetsBucket
    # Logging Configuration
    LOG_LEVEL: ${env:LOG_LEVEL, self:custom.logLevels.${self:provider.stage}, 'INFO'}
    SERVICE_NAME: qwiktax
    ENABLE_REQUEST_LOGGING: true
    # Custom Domain Configuration
    API_DOMAIN: ${self:custom.domainMapping.${self:provider.stage}, 'devapi.qwiktax.in'}
    API_BASE_URL: https://${self:custom.domainMapping.${self:provider.stage}, 'devapi.qwiktax.in'}
  iam:
    role:
      name: qwiktax-${opt:stage, self:provider.stage}-role
      statements:
        - Effect: "Allow" # xray permissions (required)
          Action:
            - "xray:PutTraceSegments"
            - "xray:PutTelemetryRecords"
          Resource:
            - "*"
        - Effect: "Allow" # DynamoDB access - scoped to specific table
          Action: 
            - "dynamodb:Query"
            - "dynamodb:Scan"
            - "dynamodb:GetItem"
            - "dynamodb:PutItem"
            - "dynamodb:UpdateItem"
            - "dynamodb:DeleteItem"
            - "dynamodb:BatchGetItem"
            - "dynamodb:BatchWriteItem"
          Resource:
            - Fn::GetAtt: [appTable, Arn]
            - Fn::Join:
                - ""
                - - Fn::GetAtt: [appTable, Arn]
                  - "/index/*"
        - Effect: "Allow"
          Action:
            ["logs:CreateLogGroup", "logs:CreateLogStream", "logs:PutLogEvents"]
          Resource: "*"
        - Effect: "Allow" # S3 access for assets (logos, images)
          Action:
            - "s3:PutObject"
            - "s3:GetObject"
            - "s3:DeleteObject"
            - "s3:PutObjectAcl"
          Resource:
            - Fn::Join:
                - ""
                - - "arn:aws:s3:::"
                  - Ref: S3AssetsBucket
                  - "/*"
        - Effect: "Allow" # S3 list bucket
          Action:
            - "s3:ListBucket"
          Resource:
            - Fn::Join:
                - ""
                - - "arn:aws:s3:::"
                  - Ref: S3AssetsBucket
        - Effect: "Allow" # SNS actions for push notifications
          Action:
            - "sns:Publish"
            - "sns:CreatePlatformEndpoint"
            - "sns:DeleteEndpoint"
            - "sns:GetEndpointAttributes"
            - "sns:SetEndpointAttributes"
            - "sns:ListEndpointsByPlatformApplication"
          Resource:
            - Ref: SNSNotificationTopic
        - Effect: "Allow" # SES for sending emails
          Action:
            - "ses:SendEmail"
            - "ses:SendRawEmail"
          Resource: "*"    
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
        - https://qwiktax.in
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true
functions: ${self:custom.functions.${self:provider.stage}}

resources:
  Resources:
    appTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: qwiktax_${self:provider.stage}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST  # On-demand pricing - no need for ProvisionedThroughput

    # SNS Topic for general notifications
    SNSNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: qwiktax-notifications-${self:provider.stage}
        DisplayName: QwikTax Notifications

    # S3 Bucket for assets (logos, images, documents)
    S3AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: qwiktax-assets-${self:provider.stage}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - 'http://localhost:3000'
                - 'http://localhost:3001'
                - 'https://*.qwiktax.in'
                - 'https://qwiktax.in'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
              MaxAge: 3600
        OwnershipControls:
          Rules:
            - ObjectOwnership: ObjectWriter

  Outputs:
    # DynamoDB Table
    DynamoDBTableName:
      Description: "DynamoDB table name"
      Value:
        Ref: appTable
      Export:
        Name: ${self:service}-${self:provider.stage}-DynamoDBTableName

    SNSNotificationTopicArn:
      Description: "SNS Topic ARN for notifications"
      Value:
        Ref: SNSNotificationTopic
      Export:
        Name: ${self:service}-${self:provider.stage}-SNSNotificationTopicArn

    S3AssetsBucketName:
      Description: "S3 Bucket for assets"
      Value:
        Ref: S3AssetsBucket
      Export:
        Name: ${self:service}-${self:provider.stage}-S3AssetsBucketName

plugins: ${self:custom.plugins.${self:provider.stage}}

custom:
  # Stage-specific plugins
  plugins:
    vikas: [] # No plugins for vikas stage
    dev: 
      - serverless-domain-manager
    prod: 
      - serverless-domain-manager
    staging: 
      - serverless-domain-manager
    test: 
      - serverless-domain-manager
  
  # Stage-specific functions
  functions:
    vikas: ${self:custom.allFunctions} # Enable functions for vikas stage
    dev: ${self:custom.allFunctions}
    prod: ${self:custom.allFunctions}
    staging: ${self:custom.allFunctions}
    test: ${self:custom.allFunctions}
  
  # All functions definition
  allFunctions:
    api:
      handler: app.handler
      events:
        # Public auth endpoints
        - httpApi:
            path: /v1/auth/signup
            method: post
        - httpApi:
            path: /v1/auth/login
            method: post
        - httpApi:
            path: /v1/auth/google
            method: post
        - httpApi:
            path: /v1/auth/confirm
            method: post
        - httpApi:
            path: /v1/auth/forgot-password
            method: post
        - httpApi:
            path: /v1/auth/confirm-forgot-password
            method: post
        - httpApi:
            path: /v1/auth/resend-code
            method: post
        # OTP-based auth endpoints
        - httpApi:
            path: /v1/auth/sendOTP
            method: post
        - httpApi:
            path: /v1/auth/verifyOTP
            method: post
        - httpApi:
            path: /v1/auth/validate-token
            method: post
        
        # SuperAdmin Routes (no authentication)
        - httpApi:
            path: /v1/superadmin/confirmuserSignup
            method: post
        - httpApi:
            path: /v1/superadmin/deleteEnterprise
            method: post
        - httpApi:
            path: /v1/superadmin/getAllEnterprises
            method: get
        - httpApi:
            path: /v1/superadmin/info
            method: get
        
        # Admin Routes (authenticated via Express middleware)
        - httpApi:
            path: /v1/admin/saveDraftSiteSettings
            method: post
        - httpApi:
            path: /v1/admin/getDraftSiteSettings
            method: get
        - httpApi:
            path: /v1/admin/publishSiteSettings
            method: post
        - httpApi:
            path: /v1/admin/getPublishedSiteSettings
            method: get
        - httpApi:
            path: /v1/admin/getLiveSiteSettings
            method: get
        
        # Public Routes (unauthenticated - for site lookup)
        - httpApi:
            path: /v1/public/site/{subdomain}
            method: get
        
        # Upload Routes (authenticated)
        - httpApi:
            path: /v1/upload/image
            method: post
        - httpApi:
            path: /v1/upload/images
            method: post
  
  # Exclude functions, events for vikas stage
  excludeVikas: ${strToBool(${self:custom.stageConfig.${self:provider.stage}.excludeResources, false})}
  
  # Stage-specific configuration
  stageConfig:
    vikas:
      excludeResources: false
    dev:
      excludeResources: false
    prod:
      excludeResources: false
    staging:
      excludeResources: false
    test:
      excludeResources: false
  
  customDomain:
    domainName: ${self:custom.domainMapping.${self:provider.stage}, 'devapi.qwiktax.in'}
    stage: ${self:provider.stage}
    basePath: ''
    certificateName: '*.qwiktax.in'
    createRoute53Record: false
    endpointType: 'regional'
    securityPolicy: tls_1_2
    apiType: http
    autoDomain: false
    enabled: ${strToBool(${self:custom.stageConfig.${self:provider.stage}.excludeResources, false})}
  
  # Log levels per stage
  logLevels:
    dev: DEBUG
    staging: INFO
    prod: WARN
    vikas: DEBUG
    test: DEBUG
  
  domainMapping:
    dev: devapi.qwiktax.in
    prod: api.qwiktax.in
    # Add more stages as needed
    staging: stagingapi.qwiktax.in
    test: testapi.qwiktax.in
  
  # Google OAuth Configuration - Stage-specific
  googleClientId:
    vikas: ${env:GOOGLE_CLIENT_ID, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    dev: ${env:GOOGLE_CLIENT_ID_DEV, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    prod: ${env:GOOGLE_CLIENT_ID_PROD, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    staging: ${env:GOOGLE_CLIENT_ID_STAGING, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    test: ${env:GOOGLE_CLIENT_ID_TEST, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
  
  googleClientSecret:
    vikas: ${env:GOOGLE_CLIENT_SECRET, ''}
    dev: ${env:GOOGLE_CLIENT_SECRET_DEV, ''}
    prod: ${env:GOOGLE_CLIENT_SECRET_PROD, ''}
    staging: ${env:GOOGLE_CLIENT_SECRET_STAGING, ''}
    test: ${env:GOOGLE_CLIENT_SECRET_TEST, ''}
  
  googleRedirectUri:
    vikas: ${env:GOOGLE_REDIRECT_URI, 'http://localhost:3000/auth/callback'}
    dev: https://admin.dev.qwiktax.in/auth/callback
    prod: https://admin.qwiktax.in/auth/callback
    staging: https://admin.staging.qwiktax.in/auth/callback
    test: https://admin.test.qwiktax.in/auth/callback
