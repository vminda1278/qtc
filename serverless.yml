# "service" is the name of this project. This will also be added to your AWS resource names.
service: qwiktax

package:
  patterns:
    - '!.env'
    - '!.env.*'
    - '!.env.example'
    - '!.env.local'
    - '!.env.backup'
    - '!node_modules/.cache/**'
    - '!node_modules/aws-sdk/**'
    - '!node_modules/nodemon/**'
    - '!test/**'
    - '!docs/**'
    - '!scripts/**'
    - '!*.md'
    - '!.git/**'
    - '!.gitignore'
    - '!.DS_Store'
    - '!.serverless/**'
  individually: false
  excludeDevDependencies: true

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'vikas'}
  profile: beejcap-aws
  region: us-east-1
  environment:
    # DynamoDB Table
    DYNAMODB_TABLE: qwiktax_${self:provider.stage}
    # Cognito Configuration - Dynamic based on stage
    COGNITO_USER_POOL_ID: 
      Ref: CognitoUserPoolMyUserPool1
    COGNITO_CLIENT_ID:
      Ref: CognitoUserPoolClient
    COGNITO_REGION: ${self:provider.region}
    COGNITO_ISSUER:
      Fn::Join:
        - ""
        - - "https://cognito-idp."
          - ${self:provider.region}
          - ".amazonaws.com/"
          - Ref: CognitoUserPoolMyUserPool1
    # SNS Platform Applications for Push Notifications (set via environment variables)
    SNS_PLATFORM_APPLICATION_IOS: ${env:SNS_PLATFORM_APPLICATION_IOS, ''}
    SNS_PLATFORM_APPLICATION_IOS_SANDBOX: ${env:SNS_PLATFORM_APPLICATION_IOS_SANDBOX, ''}
    SNS_PLATFORM_APPLICATION_ANDROID: ${env:SNS_PLATFORM_APPLICATION_ANDROID, ''}
    # Stage and Region
    STAGE: ${self:provider.stage}
    # JWT Secret for OTP-based authentication
    JWT_SECRET: ${env:JWT_SECRET}
    # Google OAuth Configuration
    GOOGLE_CLIENT_ID: ${self:custom.googleClientId.${self:provider.stage}}
    GOOGLE_CLIENT_SECRET: ${self:custom.googleClientSecret.${self:provider.stage}}
    GOOGLE_REDIRECT_URI: ${self:custom.googleRedirectUri.${self:provider.stage}}
    # S3 Bucket for assets
    S3_ASSETS_BUCKET:
      Ref: S3AssetsBucket
    # Logging Configuration
    LOG_LEVEL: ${env:LOG_LEVEL, self:custom.logLevels.${self:provider.stage}, 'INFO'}
    SERVICE_NAME: qwiktax
    ENABLE_REQUEST_LOGGING: true
    # Custom Domain Configuration
    API_DOMAIN: ${self:custom.domainMapping.${self:provider.stage}, 'devapi.qwiktax.ai'}
    API_BASE_URL: https://${self:custom.domainMapping.${self:provider.stage}, 'devapi.qwiktax.ai'}
  iam:
    role:
      name: qwiktax-${opt:stage, self:provider.stage}-role
      statements:
        - Effect: "Allow" # xray permissions (required)
          Action:
            - "xray:PutTraceSegments"
            - "xray:PutTelemetryRecords"
          Resource:
            - "*"
        - Effect: "Allow" # DynamoDB access - scoped to specific table
          Action: 
            - "dynamodb:Query"
            - "dynamodb:Scan"
            - "dynamodb:GetItem"
            - "dynamodb:PutItem"
            - "dynamodb:UpdateItem"
            - "dynamodb:DeleteItem"
            - "dynamodb:BatchGetItem"
            - "dynamodb:BatchWriteItem"
          Resource:
            - Fn::GetAtt: [appTable, Arn]
            - Fn::Join:
                - ""
                - - Fn::GetAtt: [appTable, Arn]
                  - "/index/*"
        - Effect: "Allow"
          Action:
            ["logs:CreateLogGroup", "logs:CreateLogStream", "logs:PutLogEvents"]
          Resource: "*"
        - Effect: "Allow" # S3 access for assets (logos, images)
          Action:
            - "s3:PutObject"
            - "s3:GetObject"
            - "s3:DeleteObject"
            - "s3:PutObjectAcl"
          Resource:
            - Fn::Join:
                - ""
                - - "arn:aws:s3:::"
                  - Ref: S3AssetsBucket
                  - "/*"
        - Effect: "Allow" # S3 list bucket
          Action:
            - "s3:ListBucket"
          Resource:
            - Fn::Join:
                - ""
                - - "arn:aws:s3:::"
                  - Ref: S3AssetsBucket
        - Effect: "Allow" # SNS actions for push notifications
          Action:
            - "sns:Publish"
            - "sns:CreatePlatformEndpoint"
            - "sns:DeleteEndpoint"
            - "sns:GetEndpointAttributes"
            - "sns:SetEndpointAttributes"
            - "sns:ListEndpointsByPlatformApplication"
          Resource:
            - Ref: SNSNotificationTopic
        - Effect: "Allow" # Cognito access - scoped to user pool
          Action:
            - "cognito-idp:AdminInitiateAuth"
            - "cognito-idp:AdminCreateUser"
            - "cognito-idp:AdminSetUserPassword"
            - "cognito-idp:AdminGetUser"
            - "cognito-idp:AdminUpdateUserAttributes"
            - "cognito-idp:AdminDeleteUser"
            - "cognito-idp:ListUsers"
          Resource:
            - Fn::GetAtt: [CognitoUserPoolMyUserPool1, Arn]
        - Effect: "Allow" # SES for sending emails
          Action:
            - "ses:SendEmail"
            - "ses:SendRawEmail"
          Resource: "*"    
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:3000
        - http://localhost:3001
        - https://qwiktax.in
        - https://qwiktax.ai
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true
functions: ${self:custom.functions.${self:provider.stage}}

resources:
  Resources:
    appTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: qwiktax_${self:provider.stage}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: PK1
            AttributeType: S
          - AttributeName: SK1
            AttributeType: S
          - AttributeName: PK2
            AttributeType: S
          - AttributeName: SK2
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: PK1
                KeyType: HASH
              - AttributeName: SK1
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: PK2
                KeyType: HASH
              - AttributeName: SK2
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST  # On-demand pricing - no need for ProvisionedThroughput
    CognitoUserPoolMyUserPool1:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: qwiktaxUserPool_${self:provider.stage}
        Schema:
          - Name: email
            Required: true
            Mutable: false
            AttributeDataType: String
          - Name: isConfirmedByAdmin
            Required: false
            Mutable: true
            AttributeDataType: Boolean
            DeveloperOnlyAttribute: false  
          - Name: role
            Required: false
            Mutable: true
            AttributeDataType: String
            DeveloperOnlyAttribute: false    
          - Name: enterpriseType
            Required: false
            Mutable: true
            AttributeDataType: String   
          - Name: eid
            Required: false
            Mutable: true
            AttributeDataType: String     
        AutoVerifiedAttributes:
          - email
        EmailConfiguration:
          EmailSendingAccount: DEVELOPER  
          SourceArn: arn:aws:ses:ap-south-1:347803923597:identity/qwiktax.ai
          From: The qwiktax Team <hello@qwiktax.ai>
        VerificationMessageTemplate:
          DefaultEmailOption: CONFIRM_WITH_CODE
          EmailMessage: | 
            Welcome to qwiktax!<br/><br/> 
            Your verification code is : {####}.<br/><br/>
            Please use this code to complete your account verification.<br/><br/>
            Thank You,<br/>
            The qwiktax Team<br/>
          EmailSubject: "[Action Required] Your account verification code"
          # Optional: If you also want to customize SMS messages
          SmsMessage: "Welcome to qwiktax! Your verification code is {####}."  
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: qwiktaxUserPoolClient_${self:provider.stage}
        UserPoolId:
          Ref: CognitoUserPoolMyUserPool1
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH

    # SNS Topic for general notifications
    SNSNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: qwiktax-notifications-${self:provider.stage}
        DisplayName: QwikTax Notifications

    # S3 Bucket for assets (logos, images, documents)
    S3AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: qwiktax-assets-${self:provider.stage}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - 'http://localhost:3000'
                - 'http://localhost:3001'
                - 'https://*.qwiktax.in'
                - 'https://qwiktax.in'
                - 'https://*.qwiktax.ai'
                - 'https://qwiktax.ai'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
              MaxAge: 3600
        OwnershipControls:
          Rules:
            - ObjectOwnership: ObjectWriter

  Outputs:
    # DynamoDB Table
    DynamoDBTableName:
      Description: "DynamoDB table name"
      Value:
        Ref: appTable
      Export:
        Name: ${self:service}-${self:provider.stage}-DynamoDBTableName

    # Cognito User Pool
    CognitoUserPoolId:
      Description: "Cognito User Pool ID"
      Value:
        Ref: CognitoUserPoolMyUserPool1
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoUserPoolId

    CognitoUserPoolClientId:
      Description: "Cognito User Pool Client ID"
      Value:
        Ref: CognitoUserPoolClient
      Export:
        Name: ${self:service}-${self:provider.stage}-CognitoUserPoolClientId

    SNSNotificationTopicArn:
      Description: "SNS Topic ARN for notifications"
      Value:
        Ref: SNSNotificationTopic
      Export:
        Name: ${self:service}-${self:provider.stage}-SNSNotificationTopicArn

    S3AssetsBucketName:
      Description: "S3 Bucket for assets"
      Value:
        Ref: S3AssetsBucket
      Export:
        Name: ${self:service}-${self:provider.stage}-S3AssetsBucketName

plugins: ${self:custom.plugins.${self:provider.stage}}

custom:
  # Stage-specific plugins
  plugins:
    vikas: [] # No plugins for vikas stage
    dev: 
      - serverless-domain-manager
    prod: 
      - serverless-domain-manager
    staging: 
      - serverless-domain-manager
    test: 
      - serverless-domain-manager
  
  # Stage-specific functions
  functions:
    vikas: ${self:custom.allFunctions} # Enable functions for vikas stage
    dev: ${self:custom.allFunctions}
    prod: ${self:custom.allFunctions}
    staging: ${self:custom.allFunctions}
    test: ${self:custom.allFunctions}
  
  # All functions definition
  allFunctions:
    PreTokenGeneration:
      handler: app.preTokenGenerationHandler
    api:
      handler: app.handler
      events:
        # Public auth endpoints
        - httpApi:
            path: /v1/auth/signup
            method: post
        - httpApi:
            path: /v1/auth/login
            method: post
        - httpApi:
            path: /v1/auth/google
            method: post
        - httpApi:
            path: /v1/auth/confirm
            method: post
        - httpApi:
            path: /v1/auth/forgot-password
            method: post
        - httpApi:
            path: /v1/auth/confirm-forgot-password
            method: post
        - httpApi:
            path: /v1/auth/resend-code
            method: post
        # OTP-based auth endpoints
        - httpApi:
            path: /v1/auth/sendOTP
            method: post
        - httpApi:
            path: /v1/auth/verifyOTP
            method: post
        - httpApi:
            path: /v1/auth/validate-token
            method: post
        
        # SuperAdmin Routes (no authentication)
        - httpApi:
            path: /v1/superadmin/confirmuserSignup
            method: post
        - httpApi:
            path: /v1/superadmin/deleteEnterprise
            method: post
        - httpApi:
            path: /v1/superadmin/getAllEnterprises
            method: get
        - httpApi:
            path: /v1/superadmin/info
            method: get
        
        # Admin Routes (authenticated via Express middleware)
        - httpApi:
            path: /v1/admin/saveDraftSiteSettings
            method: post
        - httpApi:
            path: /v1/admin/getDraftSiteSettings
            method: get
        - httpApi:
            path: /v1/admin/publishSiteSettings
            method: post
        - httpApi:
            path: /v1/admin/getPublishedSiteSettings
            method: get
        - httpApi:
            path: /v1/admin/getLiveSiteSettings
            method: get
        
        # Public Routes (unauthenticated - for site lookup)
        - httpApi:
            path: /v1/public/site/{subdomain}
            method: get
        
        # Upload Routes (authenticated)
        - httpApi:
            path: /v1/upload/image
            method: post
        - httpApi:
            path: /v1/upload/images
            method: post
  
  # Exclude functions, events for vikas stage
  excludeVikas: ${strToBool(${self:custom.stageConfig.${self:provider.stage}.excludeResources, false})}
  
  # Stage-specific configuration
  stageConfig:
    vikas:
      excludeResources: false
    dev:
      excludeResources: false
    prod:
      excludeResources: false
    staging:
      excludeResources: false
    test:
      excludeResources: false
  
  customDomain:
    domainName: ${self:custom.domainMapping.${self:provider.stage}, 'devapi.qwiktax.ai'}
    stage: ${self:provider.stage}
    basePath: ''
    certificateName: '*.qwiktax.ai'
    createRoute53Record: false
    endpointType: 'regional'
    securityPolicy: tls_1_2
    apiType: http
    autoDomain: false
    enabled: ${strToBool(${self:custom.stageConfig.${self:provider.stage}.excludeResources, false})}
  
  # Log levels per stage
  logLevels:
    dev: DEBUG
    staging: INFO
    prod: WARN
    vikas: DEBUG
    test: DEBUG
  
  domainMapping:
    dev: devapi.qwiktax.ai
    prod: api.qwiktax.ai
    # Add more stages as needed
    staging: stagingapi.qwiktax.ai
    test: testapi.qwiktax.ai
  
  # Google OAuth Configuration - Stage-specific
  googleClientId:
    vikas: ${env:GOOGLE_CLIENT_ID, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    dev: ${env:GOOGLE_CLIENT_ID_DEV, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    prod: ${env:GOOGLE_CLIENT_ID_PROD, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    staging: ${env:GOOGLE_CLIENT_ID_STAGING, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
    test: ${env:GOOGLE_CLIENT_ID_TEST, '712305779097-k5ap7d3kharrco4b5rqa6rkj3j49v1t9.apps.googleusercontent.com'}
  
  googleClientSecret:
    vikas: ${env:GOOGLE_CLIENT_SECRET, ''}
    dev: ${env:GOOGLE_CLIENT_SECRET_DEV, ''}
    prod: ${env:GOOGLE_CLIENT_SECRET_PROD, ''}
    staging: ${env:GOOGLE_CLIENT_SECRET_STAGING, ''}
    test: ${env:GOOGLE_CLIENT_SECRET_TEST, ''}
  
  googleRedirectUri:
    vikas: ${env:GOOGLE_REDIRECT_URI, 'http://localhost:3000/auth/callback'}
    dev: https://dev.qwiktax.in/auth/callback
    prod: https://qwiktax.in/auth/callback
    staging: https://staging.qwiktax.in/auth/callback
    test: https://test.qwiktax.in/auth/callback
